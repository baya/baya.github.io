---
layout: post
title: 好玩的翻译
---

客户提出了一个需求: 希望在页面上直接编辑修改翻译内容。这是一个非常好的需求，因为页面上可以很直观地反映翻译(国际化)的效果，如果翻译内容不正确或者有缺失，客户则直接在
页面上修改或添加翻译内容, 这种修改效果是非常好的, 很有所见即所得的范儿。接下来我们站在客户的角度上去思考和实现这个需求。

## 需求分析

1. 无关的用户不能修改页面上的翻译内容，所以需要分配一个专门的用户去编辑翻译内容。

2. 在页面上为翻译内容添加一些特殊的标识来区分翻译内容和非翻译内容。

3. 需要给客户提供一个比较友好的 UI 来查看和编辑翻译内容。


## 初步设计

对于需求分析中的第 1 点，我们考虑增加一个叫 translator 即翻译者的角色，只有拥有这个角色的用户才能在页面上编辑翻译内容。

对于第 2 点，我们考虑重写 view 视图里的 helper 方法 `t`, 通过 `t` 方法在页面中插入翻译标识。

对于第 3 点，我们考虑以弹出框的形式在当前页面弹出一个 form 表单来编辑翻译内容。


心中有文字还不够，我们还要做到心中有图，为此我们还需要将设计以图的形式表现出来:

![t](/images/Snip20160403_40.png)


## 实现细节

有了设计图(blueprint), 我们可以根据上面的设计图来编写我们的实现细节:

1. 创建 User 和 Role 模型, User 和 Role 通过中间表 roles_users 关联。

2. 创建 translator 角色, 将此角色赋予给某 user 对象。

3. 实现 I18n 的 backend, 可以使用 Redis 数据库作为 backend。

4. 重写 `t` 方法: 如果当前登录用户是 translator, 则插入翻译编辑标识，如果当前用户不是 translator, 则不插入翻译编辑标识。

5. 鼠标移动到带翻译标识的元素上时，出现提示内容: 关闭提示和编辑，提示内容由 [qtip2](http://qtip2.com//) 实现。

6. 用户点击编辑按钮时弹出编辑表单，表单内容通过 Ajax 从服务器获取, 表单弹出效果由[fancybox](http://fancybox.net/) 实现。

7. 用户提交编辑后的翻译内容到服务器，服务器更新 Redis 数据库中的翻译内容。

8. 无论是获取编辑表单还是保存翻译内容，服务端都需要验证当前用户是否是 translator。 

我们将以一个 demo 项目为基础开始实现线上编辑翻译内容的功能，这个 demo 项目已经实现了 1, 2, 3 步，我们将重点放在实现 4,5,6,7,8 上。

## 编写代码
